<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        *{
            margin: 0;
            padding: 0;
        }
        #map{
            position: relative;
            width: 400px;
            height: 400px;
            background: #000;
            margin: 10px 0 0 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
</body>
</html>
<script>
    class Map {
        constructor(el, rect = 10) {
            this.el = el
            this.rect = rect
            this.data = [
                /*{
                    x: 10,
                    y: 5,
                    color: 'red'
                }*/
            ]
            this.rows = Math.ceil(Map.getStyle(el, 'height') / rect)
            this.cells = Math.ceil(Map.getStyle(el, 'width') / rect)
            Map.setStyle(el, 'height', this.rows*rect)
            Map.setStyle(el, 'width', this.cells*rect)
        }

        static getStyle(el, attr) {
            return parseFloat(getComputedStyle(el)[attr])
        }

        static setStyle(el, attr, val) {
            el.style[attr] = val + 'px'
        }

        setData(newData) {
            this.data = this.data.concat(newData)
        }

        clearData() {
            this.data.length = 0
        }

        include({x, y}) {
            return !!this.data.find(item => item.x === x && item.y === y)
        }

        render() {
            this.el.innerHTML = this.data.map(item => {
                return `
                    <span style="position: absolute;left: ${item.x*this.rect}px;top: ${item.y*this.rect}px;
                    width: ${this.rect}px;height: ${this.rect}px;background: ${item.color};"></span>
                `
            }).join('')
        }
    }

    class Food {
        constructor(map, colors = ['red', 'blue', 'yellow', 'pink']) {
            this.map = map
            this.colors = colors
            this.data = null
        }

        create() {
            let x = Math.floor(Math.random()*this.map.cells)
            let y = Math.floor(Math.random()*this.map.rows)
            let color = this.colors[parseInt(Math.random()*this.colors.length)]
            this.data = {x, y, color}
            if(this.map.include(this.data)){
                this.create()
            }
            this.map.setData(this.data)
        }
    }

    class Snake {
        constructor(map, food) {
            this.map = map
            this.food = food
            this.direction = 'right'
            this.data = [
                {x: 6, y: 4, color: 'green'},
                {x: 5, y: 4, color: 'white'},
                {x: 4, y: 4, color: 'white'},
                {x: 3, y: 4, color: 'white'},
                {x: 2, y: 4, color: 'white'}
            ]
            this.map.setData(this.data)
        }

        move() {
            /* 让后边每一格走到前一格的位置上 */
            for(let i = this.data.length - 1; i > 0; i--) {
                this.data[i].x = this.data[i-1].x
                this.data[i].y = this.data[i-1].y
            }

            /* 移动蛇头 */
            switch(this.direction) {
                case 'left':
                    this.data[0].x--
                    break
                case 'right':
                    this.data[0].x++
                    break
                case 'top':
                    this.data[0].y--
                    break
                case 'bottom':
                    this.data[0].y++
                    break

            }
        }

        changeDir(dir) {
            console.log('dir', dir)
            /*
                如果蛇本身在左右移动，只能修改让蛇上下移动，
                如果蛇本身在上下移动，只能修改让蛇左右移动
            */
            if (this.direction === 'left' || this.direction === 'right') {
                if (dir === 'left' || dir === 'right') {
                    return false // 不能修改方向
                }
            }else {
                if (dir === 'top' || dir === 'bottom') {
                    return false // 不能修改方向
                }
            }
            this.direction = dir
            console.log('direction', this.direction)
            return true
        }

        // 吃到了食物，蛇变大了
        eatFood() {

        }
    }

    let map = document.querySelector('#map')
    let gameMap = new Map(map, 10)
    let gameFood = new Food(gameMap)
    let gameSnake = new Snake(gameMap, gameFood)
    gameMap.render()
    setInterval(() => {
        gameSnake.move()
        gameMap.clearData()
        gameMap.setData(gameSnake.data)
        gameMap.render()
    }, 200)

    setTimeout(() => {
        gameSnake.changeDir('bottom')
    }, 2000)

    setTimeout(() => {
        gameSnake.changeDir('left')
    }, 4000)

    setTimeout(() => {
        gameSnake.changeDir('top')
    }, 6000)

    /*setInterval(()=>{
        gameFood.create()
        gameMap.setData(gameFood.data)
        gameMap.render()
    },200)*/


</script>