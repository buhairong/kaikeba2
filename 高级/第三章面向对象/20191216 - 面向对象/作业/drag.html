<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        #box {
            position: absolute;
            top: 50px;
            left: 50px;
            width: 50px;
            height: 50px;
            background: red;
        }
    </style>
</head>
<body>
<div id="box"></div>
</body>
</html>
<script>
    /*
    *   event: {
    *       event:{
    *           start: [fn1, fn2, fn3...],
    *           move: [fn1, fn2, fn3...],
    *           end: [fn1, fn2, fn3...],
    *       },
    *       on: function(){},
    *       off: function(){},
    *       dispatch: function(){}
    *   }
    */

    // 事件
    class Event {
        events = {} // 事件池

        // 注册事件
        on(eventName, fn) {
            if (!this.events[eventName]) {
                this.events[eventName] = []
            }

            this.events[eventName].push(fn)
        }

        // 删除事件
        off(eventName, fn) {
            if (!this.events[eventName]) {
                return
            }

            this.events[eventName] = this.events[eventName].filter(item => item != fn)
        }

        // 执行事件
        dispatch(eventName, ...arg) {
            if (!this.events[eventName]) {
                return
            }

            this.events[eventName].forEach(item => {
                item.call(this, ...arg)
            })
        }
    }

    class BaseDrag extends Event {
        constructor(el) {
            super()
            this.el = el
            this.startEL = {} // 元素初始位置
            this.startMouse = {} // 鼠标初始位置
            this.start()
        }

        start() {
            let move = (e) => {
                this.move(e)
            }

            this.el.addEventListener('mousedown', (e) => {
                e.preventDefault()
                this.startMouse = {
                    x: e.clientX,
                    y: e.clientY
                }

                this.dispatch('dragstart', e)

                document.addEventListener('mousemove', move)
                document.addEventListener('mouseup', () => {
                    document.removeEventListener('mousemove', move)
                },{once: true})
            })
        }

        // 元素移动
        move(e) {
            let nowMouse = {
                x: e.clientX,
                y: e.clientY
            }

            let disMouse = {
                x: nowMouse.x - this.startMouse.x,
                y: nowMouse.y - this.startMouse.y
            }

           this.dispatch('drag', e, nowMouse, disMouse)
        }

        // 获取元素当前位置
        getOffset() {
            return {
                x: parseFloat(getComputedStyle(this.el)['left']),
                y: parseFloat(getComputedStyle(this.el)['top'])
            }
        }

        // 存储元素当前位置
        setOffset(dis) {
            this.el.style.left = dis.x + this.startEL.x + 'px'
            this.el.style.top = dis.y + this.startEL.y + 'px'
        }
    }

    class Drag extends BaseDrag {
        constructor(el) {
            super(el)
            this.on('dragstart', (e) => {
                this.startEL = this.getOffset()
                e.preventDefault()
            })

            this.on('drag', (e, nowMouse, disMouse) => {
                this.setOffset(disMouse)
            })
        }
    }

    class CopyDrag extends BaseDrag {
        constructor(el) {
            super(el)
            this.on('dragcopystart', e => {
                this.startEL = this.getOffset()
                e.preventDefault()
            })

            this.on('dragcopy', (e, nowMouse, disMouse) => {
                this.setOffset(disMouse)
            })
        }
    }

    {
        let box = document.querySelector('#box')
        let drag = new Drag(box)

    }
</script>